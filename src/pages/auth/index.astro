---
import Auth from "../../layouts/Auth.astro";
---

<Auth title="ورود | ثبت نام">
    <div
        class="bg-dot-rgba(1,1,1,0.1) dark:bg-dot-rgba(254,254,255,0.1) relative flex min-h-screen w-full items-center justify-center overflow-x-hidden bg-background"
    >
        <div
            class="pointer-events-none absolute inset-0 flex items-center justify-center bg-background [mask-image:radial-gradient(ellipse_at_center,transparent_80%,black)] lg:[mask-image:radial-gradient(ellipse_at_center,transparent_20%,black)]"
        >
        </div>
        <!-- background -->
        <div
            class="pointer-events-none absolute inset-0 flex w-screen items-center justify-center overflow-hidden [mask-image:radial-gradient(transparent_15%,white)]"
        >
            <svg
                class="absolute left-0 top-0 h-full w-full stroke-black/10 stroke-[2] [mask-image:linear-gradient(transparent_15%,white,transparent_85%)] dark:stroke-white/10"
                data-n-ids='{"1a4MN34vH0:0":"1a4MN34vH0:0"}'
            >
                <rect
                    width="100%"
                    height="100%"
                    stroke-width="0"
                    fill="url(#grid-pattern-1a4MN34vH0:0)"></rect>
                <svg>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="97"
                        y="97"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="385"
                        y="193"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="193"
                        y="289"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="673"
                        y="289"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="481"
                        y="385"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1249"
                        y="97"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1"
                        y="481"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="577"
                        y="481"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1441"
                        y="385"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1057"
                        y="289"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="961"
                        y="481"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1249"
                        y="577"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                </svg>
                <defs>
                    <pattern
                        id="grid-pattern-1a4MN34vH0:0"
                        viewBox="0 0 64 64"
                        width="96"
                        height="96"
                        patternUnits="userSpaceOnUse"
                    >
                        <path d="M64 0H0V64" fill="none"></path>
                    </pattern>
                </defs>
            </svg>

            <svg
                width="1512"
                height="1714"
                viewBox="0 0 1512 1714"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                class="pointer-events-none absolute left-0 top-0 h-auto w-full lg:w-1/2"
            >
                <g clip-path="url(#clip0_143_13)">
                    <g filter="url(#filter0_f_143_13)">
                        <path
                            d="M1045.18 982.551C1129.83 903.957 204.996 477.237 -235.529 294L-339.645 584.211C59.2367 752.376 960.521 1061.15 1045.18 982.551Z"
                            fill="white"
                            fill-opacity="0.15"></path>
                    </g>
                </g>
                <defs>
                    <filter
                        id="filter0_f_143_13"
                        x="-595.645"
                        y="38"
                        width="1902.26"
                        height="1213.13"
                        filterUnits="userSpaceOnUse"
                        color-interpolation-filters="sRGB"
                    >
                        <feFlood flood-opacity="0" result="BackgroundImageFix"
                        ></feFlood>
                        <feBlend
                            mode="normal"
                            in="SourceGraphic"
                            in2="BackgroundImageFix"
                            result="shape"></feBlend>
                        <feGaussianBlur
                            stdDeviation="64"
                            result="effect1_foregroundBlur_143_13"
                        ></feGaussianBlur>
                    </filter>
                    <clipPath id="clip0_143_13">
                        <rect width="1512" height="1714" fill="white"></rect>
                    </clipPath>
                </defs>
            </svg>
        </div>
        <div class="absolute left-2 top-2">
            <button onclick="toggleDark(event)" class="icon-btn h-10 w-10">
                <i class="i-carbon-moon !h-6 !w-6 dark:i-carbon-sun"></i>
            </button>
        </div>

        <div class="z-10 w-full py-10 xs:container">
            <div
                class="relative mx-auto bg-muted px-4 py-8 xs:max-w-[440px] xs:rounded-xl lg:px-10 lg:py-12"
            >
                <form id="auth-form" class="flex flex-col">
                    <!-- logo -->
                    <a href="/" class="mb-10">
                        <img
                            src="/src/assets/images/logo.png"
                            alt="logo"
                            class="mx-auto h-10 xs:h-12"
                        />
                    </a>

                    <h1 class="mb-8 text-center font-medium xs:text-lg">
                        ورود | ثبت نام
                    </h1>

                    <!-- auth method toggle -->
                    <div class="mb-6 flex items-center justify-center gap-2">
                        <button
                            type="button"
                            id="otp-toggle"
                            class="auth-toggle-btn active flex-1 rounded-lg border py-2 text-sm transition-all xs:text-base"
                        >
                            کد تایید
                        </button>
                        <button
                            type="button"
                            id="password-toggle"
                            class="auth-toggle-btn flex-1 rounded-lg border py-2 text-sm transition-all xs:text-base"
                        >
                            رمز عبور
                        </button>
                    </div>

                    <!-- username -->
                    <div class="mb-4 w-full space-y-3">
                        <label
                            for="username"
                            class="relative block w-full rounded-lg border bg-muted shadow-sm duration-300 focus-within:border-primary"
                        >
                            <input
                                dir="ltr"
                                type="text"
                                id="username"
                                name="username"
                                placeholder=" "
                                class="peer w-full rounded-lg bg-transparent p-3 text-left placeholder-transparent outline-none focus:ring-0 xs:p-4"
                            />
                            <span
                                class="pointer-events-none absolute start-3 -translate-y-1/2 rounded-full bg-muted px-2 text-xs text-text/80 transition-all duration-200 peer-placeholder-shown:top-1/2 peer-placeholder-shown:text-sm peer-focus:text-xs peer-focus:peer-placeholder-shown:top-0 xs:text-sm md:text-sm md:peer-placeholder-shown:text-base md:peer-focus:text-sm lg:start-5"
                            >
                                شماره موبایل یا ایمیل
                            </span>
                        </label>
                        <p id="error-message" class="h-5 text-sm text-warning">
                            <!-- شماره موبایل یا ایمیل نامعتبر می باشد -->
                        </p>
                    </div>

                    <button class="btn-primary py-3">ورود</button>
                    <!-- rules -->
                    <p class="mt-5 text-center text-sm text-text/80">
                        با ورود به فروشگاه, کلیه
                        <a
                            href="/rules"
                            class="text-primary duration-200 hover:text-primary/80"
                            >قوانین</a
                        >
                        را می‌پذیرم.
                    </p>
                </form>
            </div>
        </div>
    </div>
    <script>
        const authForm = document.getElementById(
            "auth-form",
        ) as HTMLFormElement;
        const errorMessage = document.getElementById("error-message");
        const otpToggle = document.getElementById("otp-toggle");
        const passwordToggle = document.getElementById("password-toggle");

        let authMethod: "otp" | "password" = "otp";

        const toggleAuthMethod = (method: "otp" | "password") => {
            authMethod = method;

            if (otpToggle && passwordToggle) {
                if (method === "otp") {
                    otpToggle.classList.add("active");
                    passwordToggle.classList.remove("active");
                } else {
                    passwordToggle.classList.add("active");
                    otpToggle.classList.remove("active");
                }
            }
        };

        if (otpToggle) {
            otpToggle.addEventListener("click", () => toggleAuthMethod("otp"));
        }

        if (passwordToggle) {
            passwordToggle.addEventListener("click", () =>
                toggleAuthMethod("password"),
            );
        }

        const showError = (message: string) => {
            if (errorMessage) {
                errorMessage.textContent = message;
            }
        };

        const clearError = () => {
            if (errorMessage) {
                errorMessage.textContent = "";
            }
        };

        const isEmail = (input: string): boolean => {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(input);
        };

        const isPhoneNumber = (input: string): boolean => {
            const phoneRegex = /^(\+98|0)?9\d{9}$/;
            return phoneRegex.test(input.replace(/\s/g, ""));
        };

        if (authForm) {
            authForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                clearError();

                const formData = new FormData(e.target as HTMLFormElement);
                const username = formData.get("username") as string;

                if (!username) return;

                const email = isEmail(username) ? username : "";
                const phoneNumber = isPhoneNumber(username)
                    ? username.replace(/\s/g, "")
                    : "";

                if (!email && !phoneNumber) {
                    showError("لطفا یک شماره موبایل یا ایمیل معتبر وارد کنید");
                    return;
                }

                try {
                    const response = await fetch(
                        "http://localhost:3000/users/initiate",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                email: email || undefined,
                                phoneNumber: phoneNumber || undefined,
                            }),
                        },
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(
                            errorData.message ||
                                "Failed to initiate authentication",
                        );
                    }

                    const data = await response.json();

                    if (data.userId && data.challengeToken) {
                        sessionStorage.setItem("emailOrPhone", username);
                        sessionStorage.setItem("userId", data.userId);
                        sessionStorage.setItem(
                            "challengeToken",
                            data.challengeToken,
                        );

                        if (authMethod === "otp") {
                            window.location.href = "/auth/login-otp";
                        } else {
                            window.location.href = "/auth/login";
                        }
                    } else {
                        showError("خطا در ورود. لطفا دوباره تلاش کنید");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showError(
                        error instanceof Error
                            ? error.message
                            : "خطا در ارتباط با سرور",
                    );
                }
            });
        }
    </script>
    <style>
        .auth-toggle-btn {
            background-color: transparent;
            color: hsl(var(--text) / 0.6);
            border-color: hsl(var(--border));
        }

        .auth-toggle-btn.active {
            background-color: hsl(var(--primary));
            color: white;
            border-color: hsl(var(--primary));
            font-weight: 500;
        }

        .auth-toggle-btn:hover:not(.active) {
            background-color: hsl(var(--muted));
            color: hsl(var(--text));
        }
    </style>
</Auth>
