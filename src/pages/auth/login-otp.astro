---
import Auth from "../../layouts/Auth.astro";
---

<Auth title="ورود با کد تایید">
    <div
        class="bg-dot-rgba(1,1,1,0.1) dark:bg-dot-rgba(254,254,255,0.1) relative flex min-h-screen w-full items-center justify-center overflow-x-hidden bg-background"
    >
        <div
            class="pointer-events-none absolute inset-0 flex items-center justify-center bg-background [mask-image:radial-gradient(ellipse_at_center,transparent_80%,black)] lg:[mask-image:radial-gradient(ellipse_at_center,transparent_20%,black)]"
        >
        </div>
        <!-- background -->
        <div
            class="pointer-events-none absolute inset-0 flex w-screen items-center justify-center overflow-hidden [mask-image:radial-gradient(transparent_15%,white)]"
        >
            <svg
                class="absolute left-0 top-0 h-full w-full stroke-black/10 stroke-[2] [mask-image:linear-gradient(transparent_15%,white,transparent_85%)] dark:stroke-white/10"
                data-n-ids='{"1a4MN34vH0:0":"1a4MN34vH0:0"}'
            >
                <rect
                    width="100%"
                    height="100%"
                    stroke-width="0"
                    fill="url(#grid-pattern-1a4MN34vH0:0)"></rect>
                <svg>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="97"
                        y="97"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="385"
                        y="193"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="193"
                        y="289"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="673"
                        y="289"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="481"
                        y="385"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1249"
                        y="97"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1"
                        y="481"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="577"
                        y="481"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1441"
                        y="385"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1057"
                        y="289"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="961"
                        y="481"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                    <rect
                        stroke-width="0"
                        width="95"
                        height="95"
                        x="1249"
                        y="577"
                        class="pointer-events-auto fill-black/5 transition duration-500 hover:fill-black/10 dark:fill-white/5 dark:hover:fill-white/10"
                    >
                    </rect>
                </svg>
                <defs>
                    <pattern
                        id="grid-pattern-1a4MN34vH0:0"
                        viewBox="0 0 64 64"
                        width="96"
                        height="96"
                        patternUnits="userSpaceOnUse"
                    >
                        <path d="M64 0H0V64" fill="none"></path>
                    </pattern>
                </defs>
            </svg>

            <svg
                width="1512"
                height="1714"
                viewBox="0 0 1512 1714"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                class="pointer-events-none absolute left-0 top-0 h-auto w-full lg:w-1/2"
            >
                <g clip-path="url(#clip0_143_13)">
                    <g filter="url(#filter0_f_143_13)">
                        <path
                            d="M1045.18 982.551C1129.83 903.957 204.996 477.237 -235.529 294L-339.645 584.211C59.2367 752.376 960.521 1061.15 1045.18 982.551Z"
                            fill="white"
                            fill-opacity="0.15"></path>
                    </g>
                </g>
                <defs>
                    <filter
                        id="filter0_f_143_13"
                        x="-595.645"
                        y="38"
                        width="1902.26"
                        height="1213.13"
                        filterUnits="userSpaceOnUse"
                        color-interpolation-filters="sRGB"
                    >
                        <feFlood flood-opacity="0" result="BackgroundImageFix"
                        ></feFlood>
                        <feBlend
                            mode="normal"
                            in="SourceGraphic"
                            in2="BackgroundImageFix"
                            result="shape"></feBlend>
                        <feGaussianBlur
                            stdDeviation="64"
                            result="effect1_foregroundBlur_143_13"
                        ></feGaussianBlur>
                    </filter>
                    <clipPath id="clip0_143_13">
                        <rect width="1512" height="1714" fill="white"></rect>
                    </clipPath>
                </defs>
            </svg>
        </div>
        <div class="absolute left-2 top-2">
            <button onclick="toggleDark(event)" class="icon-btn h-10 w-10">
                <i class="i-carbon-moon !h-6 !w-6 dark:i-carbon-sun"></i>
            </button>
        </div>

        <div class="z-10 w-full py-10 xs:container">
            <div
                class="relative mx-auto bg-muted px-4 py-8 xs:max-w-[440px] xs:rounded-xl lg:px-10 lg:py-12"
            >
                <!-- Return previous Section -->
                <a
                    href="/auth"
                    class="absolute right-2 top-2 flex size-10 items-center justify-center rounded-full border bg-background text-primary duration-300 hover:bg-primary-btn hover:text-background xs:-right-2 xs:-top-2"
                >
                    <i class="i-carbon-chevron-right size-7 stroke-2"></i>
                </a>
                <form class="flex flex-col">
                    <!-- logo -->
                    <a href="/" class="mb-10">
                        <img
                            src="/src/assets/images/logo.png"
                            alt="logo"
                            class="mx-auto h-10 xs:h-12"
                        />
                    </a>

                    <h1 class="mb-8 text-center font-medium xs:text-lg">
                        کد تایید را وارد کنید
                    </h1>

                    <!-- otp -->
                    <div class="mb-4 w-full space-y-6">
                        <div
                            id="otp-form"
                            class="flex items-center justify-between gap-x-2"
                            dir="ltr"
                        >
                            <input
                                type="number"
                                inputmode="numeric"
                                class="otp-input h-14 w-14 rounded-lg border bg-muted text-center text-lg outline-none xs:h-16 xs:w-16 md:text-xl"
                                maxlength="1"
                            />
                            <input
                                type="number"
                                inputmode="numeric"
                                class="otp-input h-14 w-14 rounded-lg border bg-muted text-center text-lg outline-none xs:h-16 xs:w-16 md:text-xl"
                                maxlength="1"
                            />
                            <input
                                type="number"
                                inputmode="numeric"
                                class="otp-input h-14 w-14 rounded-lg border bg-muted text-center text-lg outline-none xs:h-16 xs:w-16 md:text-xl"
                                maxlength="1"
                            />
                            <input
                                type="number"
                                inputmode="numeric"
                                class="otp-input h-14 w-14 rounded-lg border bg-muted text-center text-lg outline-none xs:h-16 xs:w-16 md:text-xl"
                                maxlength="1"
                            />
                        </div>
                        <p class="h-5 text-sm text-warning">
                            کد تایید اشتباه میباشد
                        </p>
                    </div>
                    <ul class="mb-6 space-y-4">
                        <li>
                            <p
                                class="text-sm text-primary/60"
                                id="countdownSection"
                            >
                                زمان باقی‌مانده تا ارسال مجدد
                                <span id="countdown" class="font-bold"
                                    >2:00</span
                                >
                            </p>
                            <button
                                id="resendButton"
                                type="button"
                                class="hidden text-sm text-primary"
                            >
                                <span> ارسال مجدد کد تایید </span>

                                <span>
                                    <svg class="h-5 w-5">
                                        <use xlink:href="#chevron-left"></use>
                                    </svg>
                                </span>
                            </button>
                        </li>
                        <li>
                            <a
                                href="/auth/login"
                                class="flex items-center gap-1 text-sm text-primary duration-200 hover:text-primary/80"
                            >
                                ورود با کلمه عبور
                                <i class="i-carbon-chevron-left size-4"></i>
                            </a>
                        </li>
                    </ul>

                    <button
                        type="button"
                        class="btn-primary py-3"
                        id="verifyButton"
                    >
                        تایید
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let countdownMinutes = 2;
        let countdownSeconds = 0;
        let countdownInterval: ReturnType<typeof setInterval>;

        function updateCountdown() {
            const countdownElement = document.getElementById("countdown");
            if (countdownElement) {
                countdownElement.textContent = `${countdownMinutes}:${countdownSeconds
                    .toString()
                    .padStart(2, "0")}`;
            }
        }

        function startCountdown() {
            countdownInterval = setInterval(function () {
                if (countdownMinutes === 0 && countdownSeconds === 0) {
                    clearInterval(countdownInterval);
                    const resendButton =
                        document.getElementById("resendButton");
                    const countdownSection =
                        document.getElementById("countdownSection");
                    if (resendButton) {
                        resendButton.classList.remove("hidden");
                        (resendButton as HTMLButtonElement).disabled = false;
                    }
                    if (countdownSection) {
                        countdownSection.classList.add("hidden");
                    }
                } else {
                    if (countdownSeconds === 0) {
                        countdownMinutes--;
                        countdownSeconds = 59;
                    } else {
                        countdownSeconds--;
                    }
                    updateCountdown();
                }
            }, 1000);
        }

        function resendOTP() {
            if (countdownMinutes != 0 || countdownSeconds != 0) return;
            countdownMinutes = 2;
            countdownSeconds = 0;
            updateCountdown();
            const resendButton = document.getElementById("resendButton");
            const countdownSection =
                document.getElementById("countdownSection");
            if (resendButton) {
                resendButton.classList.add("hidden");
                (resendButton as HTMLButtonElement).disabled = true;
            }
            if (countdownSection) {
                countdownSection.classList.remove("hidden");
            }

            startCountdown();
        }

        startCountdown(); // Start the countdown when the page loads

        const form = document.querySelector("#otp-form");
        const inputs = document.querySelectorAll(
            ".otp-input",
        ) as NodeListOf<HTMLInputElement>;

        if (inputs.length > 0) {
            inputs[0].focus();
        }

        const isAllInputFilled = () => {
            return Array.from(inputs).every((item) => item.value);
        };

        const getOtpText = () => {
            return Array.from(inputs)
                .map((input) => input.value)
                .join("");
        };

        const verifyOTP = () => {
            if (isAllInputFilled()) {
                const text = getOtpText();
                alert(`Your OTP is "${text}". OTP is correct`);
            }
        };

        const toggleFilledClass = (field: HTMLInputElement) => {
            if (field.value) {
                field.classList.add("!border-primary");
            } else {
                field.classList.remove("!border-primary");
            }
        };

        if (form) {
            form.addEventListener("input", (e) => {
                const target = e.target as HTMLInputElement;
                const value = target.value;

                if (!/^\d$/.test(value)) {
                    target.value = ""; // Allow only single digits
                    return;
                }

                toggleFilledClass(target);

                if (target.nextElementSibling && value) {
                    (target.nextElementSibling as HTMLInputElement).focus();
                }

                if (isAllInputFilled()) {
                    verifyOTP(); // Call alert every time all inputs are filled
                }
            });
        }

        inputs.forEach((input, currentIndex) => {
            toggleFilledClass(input);

            input.addEventListener("paste", (e) => {
                e.preventDefault();
                const text = e.clipboardData
                    ?.getData("text")
                    .replace(/\D/g, "")
                    .slice(0, inputs.length - currentIndex);

                if (text) {
                    inputs.forEach((item, index) => {
                        if (
                            index >= currentIndex &&
                            text[index - currentIndex]
                        ) {
                            item.focus();
                            item.value = text[index - currentIndex];
                            toggleFilledClass(item);
                        }
                    });

                    if (isAllInputFilled()) {
                        verifyOTP(); // Call alert every time all inputs are filled
                    }
                }
            });

            input.addEventListener("keydown", (e) => {
                if (e.key === "Backspace" || e.key === "Delete") {
                    e.preventDefault();
                    input.value = "";
                    toggleFilledClass(input);
                    if (input.previousElementSibling) {
                        (
                            input.previousElementSibling as HTMLInputElement
                        ).focus();
                    }
                }
            });

            input.addEventListener("input", () => {
                if (input.value.length > 1) {
                    input.value = input.value.slice(-1); // Keep only the last digit
                }
            });
        });

        // Add event listener to resend button
        const resendButton = document.getElementById("resendButton");
        if (resendButton) {
            resendButton.addEventListener("click", resendOTP);
        }

        // Add event listener to verify button
        const verifyButton = document.getElementById("verifyButton");
        if (verifyButton) {
            verifyButton.addEventListener("click", verifyOTP);
        }
    </script>
</Auth>
